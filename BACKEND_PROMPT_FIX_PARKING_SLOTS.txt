üö® URGENT: Fix Multiple Tables - Fields Are NULL When Booking Confirmed üö®
===========================================================================

PROBLEM:
--------
When admin confirms a booking, multiple tables have NULL fields that should be populated:

‚ùå TABLE 1: bookings
   - vehicle_id = NULL (should have the vehicle ID)
   - slot_id = NULL (should have the assigned parking slot ID)

‚ùå TABLE 2: parking_slots
   - booking_id = NULL (should have the booking ID)
   - user_id = NULL (should have the user ID)
   - vehicle_id = NULL (should have the vehicle ID)
   - user_firstname = NULL (should have user's first name)
   - user_lastname = NULL (should have user's last name)
   - vehicle_type = NULL (should have 'Car', 'Motorcycle', etc.)
   - vehicle_model = NULL (should have 'Toyota Camry', etc.)
   - plate_number = NULL (should have 'ABC123', etc.)
   - reserved = NULL (should be TRUE for occupied, FALSE for vacant)

See screenshot: Slots 1 and 2 show status='occupied' but ALL other fields are NULL!

This is because the backend ONLY updates the status field, but doesn't populate
the complete user, vehicle, and booking information when confirming a booking.

ROOT CAUSE:
-----------
The PUT /api/parking-slots/{slotId} endpoint receives:
  Body: { status: 'occupied' }

And executes:
  UPDATE parking_slots SET status = 'occupied' WHERE slot_id = ?

But it DOESN'T update the other fields with booking/user/vehicle data!

THE FIX NEEDED:
===============

STEP 1: Update the Booking Confirmation Endpoint
-------------------------------------------------
File: BookingController.java (or similar)

When admin confirms a booking, you need to:

1. Get the booking details including user_id and vehicle info
2. Find the first vacant parking slot for that parking lot
3. Update that slot with COMPLETE information, not just status

Example Java Code:

@PutMapping("/bookings/{bookingId}/confirm")
public ResponseEntity<?> confirmBooking(@PathVariable Long bookingId) {
    try {
        // 1. Get the booking
        Booking booking = bookingRepository.findById(bookingId)
            .orElseThrow(() -> new RuntimeException("Booking not found"));
        
        // 2. Get the user who made the booking
        User user = userRepository.findById(booking.getUserId())
            .orElseThrow(() -> new RuntimeException("User not found"));
        
        // 3. Get the user's vehicle
        Vehicle vehicle = vehicleRepository.findByUserId(booking.getUserId())
            .orElseThrow(() -> new RuntimeException("Vehicle not found"));
        
        // 4. Find first vacant slot for this parking lot
        List<ParkingSlot> slots = parkingSlotRepository
            .findByParkingLotId(booking.getParkingLotId());
        
        ParkingSlot vacantSlot = slots.stream()
            .filter(s -> "vacant".equalsIgnoreCase(s.getStatus()))
            .findFirst()
            .orElseThrow(() -> new RuntimeException("No vacant slots available"));
        
        // 5. ‚≠ê UPDATE THE BOOKING WITH VEHICLE AND SLOT INFO ‚≠ê
        booking.setStatus("confirmed");
        booking.setVehicleId(vehicle.getVehicleId());  // ‚≠ê FIX: Add vehicle_id
        booking.setSlotId(vacantSlot.getSlotId());     // ‚≠ê FIX: Add slot_id
        bookingRepository.save(booking);
        
        // 6. ‚≠ê UPDATE THE PARKING SLOT WITH COMPLETE INFORMATION ‚≠ê
        vacantSlot.setStatus("occupied");
        vacantSlot.setReserved(true);                           // ‚≠ê FIX: Set reserved = true
        vacantSlot.setBookingId(bookingId);                     // ‚≠ê FIX: Add booking_id
        vacantSlot.setUserId(user.getUserId());                 // ‚≠ê FIX: Add user_id
        vacantSlot.setVehicleId(vehicle.getVehicleId());        // ‚≠ê FIX: Add vehicle_id
        vacantSlot.setUserFirstname(user.getFirstname());       // ‚≠ê FIX: Add user_firstname
        vacantSlot.setUserLastname(user.getLastname());         // ‚≠ê FIX: Add user_lastname
        vacantSlot.setVehicleType(booking.getVehicleType());    // ‚≠ê FIX: Add vehicle_type
        vacantSlot.setVehicleModel(vehicle.getModel());         // ‚≠ê FIX: Add vehicle_model
        vacantSlot.setPlateNumber(vehicle.getPlateNumber());    // ‚≠ê FIX: Add plate_number
        vacantSlot.setVehicleColor(vehicle.getColor());         // Optional: vehicle_color
        
        parkingSlotRepository.save(vacantSlot);
        
        System.out.println("‚úì Booking confirmed: ID=" + bookingId);
        System.out.println("‚úì Updated booking: vehicle_id=" + vehicle.getVehicleId() + ", slot_id=" + vacantSlot.getSlotId());
        System.out.println("‚úì Updated slot: booking_id=" + bookingId + ", user_id=" + user.getUserId() + ", reserved=true");
        
        return ResponseEntity.ok(Map.of(
            "message", "Booking confirmed",
            "slotNumber", vacantSlot.getSlotNumber(),
            "vehicleId", vehicle.getVehicleId(),
            "slotId", vacantSlot.getSlotId()
        ));
        
    } catch (Exception e) {
        e.printStackTrace();
        return ResponseEntity.status(500).body(Map.of("error", e.getMessage()));
    }
}


STEP 2: Also Update the Direct Slot Update Endpoint
----------------------------------------------------
File: ParkingSlotController.java (or similar)

When frontend calls PUT /api/parking-slots/{slotId} to change status,
if changing to 'occupied', require additional data:

@PutMapping("/parking-slots/{slotId}")
public ResponseEntity<?> updateSlot(
    @PathVariable Long slotId,
    @RequestBody Map<String, Object> updates) {
    
    try {
        ParkingSlot slot = parkingSlotRepository.findById(slotId)
            .orElseThrow(() -> new RuntimeException("Slot not found"));
        
        // Update status
        if (updates.containsKey("status")) {
            String newStatus = (String) updates.get("status");
            slot.setStatus(newStatus);
            
            // If freeing the slot (vacant), clear all user/vehicle data
            if ("vacant".equalsIgnoreCase(newStatus)) {
                slot.setReserved(false);           // ‚≠ê Set reserved = false
                slot.setBookingId(null);
                slot.setUserId(null);
                slot.setVehicleId(null);
                slot.setUserFirstname(null);
                slot.setUserLastname(null);
                slot.setVehicleType(null);
                slot.setVehicleModel(null);
                slot.setPlateNumber(null);
                slot.setVehicleColor(null);
            }
            // If occupying the slot, set reserved = true
            else if ("occupied".equalsIgnoreCase(newStatus)) {
                slot.setReserved(true);            // ‚≠ê Set reserved = true
            }
        }
        
        parkingSlotRepository.save(slot);
        return ResponseEntity.ok(slot);
        
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of("error", e.getMessage()));
    }
}


STEP 3: Add Missing Columns to Database (If Not Exist)
-------------------------------------------------------
Run this SQL to ensure all columns exist:

-- Update bookings table
ALTER TABLE bookings 
ADD COLUMN IF NOT EXISTS vehicle_id INT NULL,
ADD COLUMN IF NOT EXISTS slot_id INT NULL;

ALTER TABLE bookings
ADD FOREIGN KEY (vehicle_id) REFERENCES vehicles(vehicle_id),
ADD FOREIGN KEY (slot_id) REFERENCES parking_slots(slot_id);

-- Update parking_slots table
ALTER TABLE parking_slots 
ADD COLUMN IF NOT EXISTS booking_id INT NULL,
ADD COLUMN IF NOT EXISTS user_id INT NULL,
ADD COLUMN IF NOT EXISTS vehicle_id INT NULL,
ADD COLUMN IF NOT EXISTS user_firstname VARCHAR(255) NULL,
ADD COLUMN IF NOT EXISTS user_lastname VARCHAR(255) NULL,
ADD COLUMN IF NOT EXISTS vehicle_type VARCHAR(50) NULL,
ADD COLUMN IF NOT EXISTS vehicle_model VARCHAR(255) NULL,
ADD COLUMN IF NOT EXISTS plate_number VARCHAR(50) NULL,
ADD COLUMN IF NOT EXISTS vehicle_color VARCHAR(50) NULL,
ADD COLUMN IF NOT EXISTS reserved BOOLEAN DEFAULT FALSE;

ALTER TABLE parking_slots
ADD FOREIGN KEY (booking_id) REFERENCES bookings(booking_id),
ADD FOREIGN KEY (user_id) REFERENCES users(user_id),
ADD FOREIGN KEY (vehicle_id) REFERENCES vehicles(vehicle_id);


STEP 4: Update Entity Classes
------------------------------

FILE 1: ParkingSlot.java
-------------------------
@Entity
@Table(name = "parking_slots")
public class ParkingSlot {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long slotId;
    
    @Column(name = "parking_lot_id")
    private Long parkingLotId;
    
    @Column(name = "slot_number")
    private Integer slotNumber;
    
    private String status; // 'vacant' or 'occupied'
    
    // ‚≠ê ADD THESE FIELDS ‚≠ê
    @Column(name = "booking_id")
    private Long bookingId;
    
    @Column(name = "user_id")
    private Long userId;
    
    @Column(name = "vehicle_id")
    private Long vehicleId;
    
    @Column(name = "user_firstname")
    private String userFirstname;
    
    @Column(name = "user_lastname")
    private String userLastname;
    
    @Column(name = "vehicle_type")
    private String vehicleType;
    
    @Column(name = "vehicle_model")
    private String vehicleModel;
    
    @Column(name = "plate_number")
    private String plateNumber;
    
    @Column(name = "vehicle_color")
    private String vehicleColor;
    
    @Column(name = "reserved")
    private Boolean reserved; // ‚≠ê true = occupied, false = vacant
    
    // Add getters and setters for all new fields
}


FILE 2: Booking.java
--------------------
@Entity
@Table(name = "bookings")
public class Booking {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long bookingId;
    
    // ... existing fields like user_id, parking_lot_id, date_reserved, etc. ...
    
    // ‚≠ê ADD THESE FIELDS ‚≠ê
    @Column(name = "vehicle_id")
    private Long vehicleId; // ‚≠ê ADD THIS to link booking to vehicle
    
    @Column(name = "slot_id")
    private Long slotId; // ‚≠ê ADD THIS to link booking to slot
    
    // Add getters and setters for both new fields
    public Long getVehicleId() { return vehicleId; }
    public void setVehicleId(Long vehicleId) { this.vehicleId = vehicleId; }
    
    public Long getSlotId() { return slotId; }
    public void setSlotId(Long slotId) { this.slotId = slotId; }
}


TESTING:
========
1. Create a booking as user
2. Admin confirms the booking
3. Check BOTH tables in MySQL:

‚úÖ CHECK 1: bookings table
   SELECT booking_id, user_id, parking_lot_id, status, vehicle_id, slot_id 
   FROM bookings 
   WHERE booking_id = <the_booking_id>;
   
   Expected:
   - status should be 'confirmed' ‚úì
   - vehicle_id should have the vehicle ID (not NULL) ‚úì
   - slot_id should have the parking slot ID (not NULL) ‚úì

‚úÖ CHECK 2: parking_slots table
   SELECT slot_id, slot_number, status, reserved, booking_id, user_id, vehicle_id,
          user_firstname, user_lastname, vehicle_type, vehicle_model, plate_number
   FROM parking_slots 
   WHERE status = 'occupied';
   
   Expected:
   - status should be 'occupied' ‚úì
   - reserved should be TRUE (1) ‚úì
   - booking_id should have the booking ID (not NULL) ‚úì
   - user_id should have the user ID (not NULL) ‚úì
   - vehicle_id should have the vehicle ID (not NULL) ‚úì
   - user_firstname should have user's name (not NULL) ‚úì
   - user_lastname should have user's name (not NULL) ‚úì
   - vehicle_type should have 'Car'/'Motorcycle'/etc (not NULL) ‚úì
   - vehicle_model should have 'Toyota Camry'/etc (not NULL) ‚úì
   - plate_number should have 'ABC123'/etc (not NULL) ‚úì

EXPECTED RESULT IN DATABASE:
============================

BOOKINGS TABLE:
booking_id | user_id | parking_lot_id | status    | vehicle_id | slot_id
45         | 5       | 1              | confirmed | 12         | 1
46         | 8       | 1              | confirmed | 15         | 2
47         | 10      | 2              | pending   | NULL       | NULL

PARKING_SLOTS TABLE:
slot_id | status   | reserved | booking_id | user_id | vehicle_id | user_firstname | vehicle_type | vehicle_model | plate_number
1       | occupied | TRUE     | 45         | 5       | 12         | John           | Car          | Toyota Camry  | ABC123
2       | occupied | TRUE     | 46         | 8       | 15         | Jane           | Motorcycle   | Honda CBR     | XYZ789
3       | vacant   | FALSE    | NULL       | NULL    | NULL       | NULL           | NULL         | NULL          | NULL

PRIORITY: üî• CRITICAL - Frontend is waiting for this data to display! üî•

The frontend already has code to display user info in parking slots, but it shows
"N/A" because the backend is sending NULL values. Fix the backend and the frontend
will automatically start showing the correct information!
